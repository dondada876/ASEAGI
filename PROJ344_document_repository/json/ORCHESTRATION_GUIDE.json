{
  "metadata": {
    "file_path": "C:\\Users\\DonBucknor_n0ufqwv\\GettingStarted\\ASEAGI\\ORCHESTRATION_GUIDE.md",
    "file_name": "ORCHESTRATION_GUIDE.md",
    "file_type": "md",
    "file_size": 14187,
    "file_hash": "cc1fa5d7a91262d483338ce4bf6a680b",
    "extraction_date": "2025-11-06T09:18:56.680071",
    "extraction_method": "direct_read",
    "title": "# Human-in-the-Loop Orchestration Guide",
    "author": null,
    "created_date": "2025-11-05T21:30:09.318311",
    "modified_date": "2025-11-05T21:30:09.318311",
    "page_count": null,
    "word_count": 1924,
    "char_count": 13303
  },
  "content": "# Human-in-the-Loop Orchestration Guide\n\n## Overview\n\nThe orchestration bot is an **intelligent agent** that knows when to ask for human help instead of guessing. It provides:\n\n1. **Uncertainty Detection** - AI identifies what it's NOT confident about\n2. **Clarifying Questions** - Asks you via chat when uncertain\n3. **Preview Before Commit** - Shows exactly what will be saved\n4. **Field Editing** - Let you fix any mistakes before upload\n5. **Error Explanations** - Human-friendly error messages with solutions\n\n---\n\n## How It Works\n\n### Traditional AI Bot (Auto-Pilot)\n```\nImage â†’ AI Analysis â†’ Save to Database\n         â†“\n    (Might guess wrong!)\n```\n\n### Orchestration Bot (Human-in-the-Loop)\n```\nImage â†’ AI Analysis â†’ Uncertainty Detection\n                           â†“\n                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”\n                   â†“              â†“\n            Confident?         Uncertain?\n                   â†“              â†“\n            Skip to Preview   Ask Questions\n                   â†“              â†“\n                Preview â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                   â†“\n            Edit Fields? (Optional)\n                   â†“\n            Final Confirmation\n                   â†“\n            Save to Database\n```\n\n---\n\n## Example Conversation Flow\n\n### Scenario: Police Report with Ambiguous Date\n\n**You:**\n> [Send police report image with caption]\n> \"Richmond PD sexual assault report\"\n\n**Bot:**\n> ðŸ” Analyzing document with AI...\n>\n> âœ… Initial Analysis Complete\n>\n> ðŸŽ¯ My Confidence: 65%\n>\n> ðŸ“ Document Type: ðŸš” Police Report\n> ðŸ“… Date: 20240804\n> ðŸ“Œ Title: Sexual Assault Report - Richmond PD\n> â­ Relevancy: 920\n>\n> ðŸ¤” **I have some questions to improve accuracy:**\n>\n> **Question 1 of 2:**\n>\n> I found two dates in the document (08/04/2024 and 08/15/2024). Which is the official document date?\n>\n> *Reason: Multiple dates found*\n\n**[Keyboard appears with options]:**\n- 20240804\n- 20240815\n- Unknown\n\n**You:**\n> 20240804\n\n**Bot:**\n> **Question 2 of 2:**\n>\n> I see a name that looks like \"J. Smith\". Is this:\n> - John Smith\n> - Jane Smith\n> - Unknown\n>\n> *Reason: Ambiguous name abbreviation*\n\n**You:**\n> Jane Smith\n\n**Bot:**\n> ðŸ“‹ **PREVIEW - What Will Be Saved**\n>\n> ðŸŽ¯ Overall Confidence: 92% (improved with your help!)\n>\n> ðŸ“ Document Type: ðŸš” Police Report\n> ðŸ“… Date: 20240804\n> ðŸ“Œ Title: Sexual Assault Report - Richmond PD\n> â­ Relevancy Score: 920\n>\n> ðŸ“„ Summary:\n> Police report documenting sexual assault allegation filed by Jane Smith on August 4, 2024...\n>\n> ðŸ“‹ Case Numbers: 24-7889\n> ðŸ‘¤ Names Mentioned: Jane Smith, Officer Rodriguez\n> ðŸ“ Locations: Richmond\n>\n> ðŸ“ OCR Text Preview:\n> RICHMOND POLICE DEPARTMENT\n> REPORT #24-7889\n> DATE: 08/04/2024...\n>\n> **What would you like to do?**\n\n**[Keyboard options]:**\n- âœ… Looks good - Upload now\n- âœï¸ Edit a field\n- âŒ Cancel\n\n**You:**\n> âœ… Looks good - Upload now\n\n**Bot:**\n> â³ Uploading to database and storage...\n>\n> âœ… **Upload Successful!**\n>\n> ðŸ†” Database ID: 1234\n> ðŸ“„ Filename: 20240804_PLCR_Sexual_Assault_Report_REL-920_20250105_143022.jpg\n> ðŸŽ¯ AI Confidence: 92%\n>\n> ðŸ”— URL: https://jvjlhxodmbkodzmggwpu.supabase.co/storage/...\n>\n> âœ¨ Your document is now saved!\n>\n> Use /start to upload another.\n\n---\n\n## When Bot Asks Questions\n\n### High Confidence (90%+) - No Questions\n```\nClear document, no ambiguity\n        â†“\nGoes straight to preview\n```\n\n### Medium Confidence (70-89%) - 1-2 Questions\n```\nSome uncertain fields\n        â†“\nAsk specific clarifying questions\n```\n\n### Low Confidence (<70%) - Multiple Questions\n```\nLots of uncertainty\n        â†“\nAsk several questions to improve accuracy\n```\n\n---\n\n## Types of Questions Asked\n\n### 1. Date Ambiguity\n**Example:**\n```\nQuestion: I found two dates (08/04/2024 and 08/15/2024).\n          Which is the document date?\n\nOptions:\n  â€¢ 20240804\n  â€¢ 20240815\n  â€¢ Unknown\n\nReason: Multiple dates found\n```\n\n### 2. Document Type Uncertainty\n**Example:**\n```\nQuestion: Is this a Police Report or a CPS Report?\n\nOptions:\n  â€¢ ðŸš” Police Report\n  â€¢ ðŸ‘¶ CPS Report\n\nReason: Header mentions both agencies\n```\n\n### 3. Name Disambiguation\n**Example:**\n```\nQuestion: The name \"J. Smith\" appears. Who is this?\n\nYour answer: [Type name or \"Unknown\"]\n\nReason: Ambiguous name abbreviation\n```\n\n### 4. Case Number Extraction\n**Example:**\n```\nQuestion: I see \"#24-7889\" and \"Case 2024-07889\".\n          Which is the correct case number?\n\nOptions:\n  â€¢ 24-7889\n  â€¢ 2024-07889\n  â€¢ Both (separate cases)\n\nReason: Multiple case number formats found\n```\n\n### 5. Relevancy Assessment\n**Example:**\n```\nQuestion: This document contains allegations of abuse.\n          Should relevancy be Critical (920) or High (850)?\n\nOptions:\n  â€¢ Critical (920) - Sexual assault allegations\n  â€¢ High (850) - General abuse allegation\n\nReason: Need context for severity scoring\n```\n\n---\n\n## Field Editing\n\nIf you see something wrong in the preview, you can edit it:\n\n**Bot shows preview:**\n```\nðŸ“ Document Type: ðŸš” Police Report\nðŸ“… Date: 20240804\nðŸ“Œ Title: Sexual Assault Report - Richmond PD\n```\n\n**You click:** âœï¸ Edit a field\n\n**Bot:**\n```\nWhich field would you like to edit?\n\n  â€¢ Document Type\n  â€¢ Document Date\n  â€¢ Title\n  â€¢ Summary/Notes\n  â€¢ Relevancy Score\n  â€¢ âŒ Cancel edit - Go back to preview\n```\n\n**You select:** Title\n\n**Bot:**\n```\nEnter new title:\n```\n\n**You type:**\n```\nInitial Sexual Assault Report - Richmond PD Case 24-7889\n```\n\n**Bot:**\n```\nâœ… Title updated!\n\n[Shows updated preview]\n```\n\n---\n\n## Error Handling with Explanations\n\n### Scenario: Duplicate Document\n\n**Bot:**\n```\nðŸ”„ **Duplicate Detected**\n\nThis document appears to be identical to one already uploaded.\n\nExisting: 20240804_PLCR_Sexual_Assault_Report_REL-920.jpg\nUploaded: 2024-08-05\nSimilarity: 100% (identical MD5 hash)\n\nOptions:\n1. Skip upload (keep existing)\n2. Upload anyway (mark as version)\n3. Replace existing document\n\nWhat would you like to do?\n```\n\n### Scenario: Storage Bucket Missing\n\n**Bot:**\n```\nâ˜ï¸ **Storage Upload Failed**\n\nCould not save image to cloud storage.\n\nPossible causes:\nâ€¢ Storage bucket 'documents' not created\nâ€¢ Network connection issue\nâ€¢ File size too large\n\nThe metadata was saved, but image upload failed.\n\nQuick fix:\n1. Go to Supabase Dashboard\n2. Storage â†’ Create bucket named 'documents'\n3. Set Public: YES\n4. Try uploading again\n\nWould you like to retry?\n```\n\n### Scenario: Database Schema Error\n\n**Bot:**\n```\nðŸ’¾ **Database Schema Issue**\n\nThe database doesn't have the expected field structure.\n\nTechnical details: Could not find the 'full_text_content' column\n\nThis might need database migration or schema update.\n\nYou can:\n1. Contact database admin\n2. Check schema in Supabase Dashboard\n3. Upload with basic metadata only (skip OCR text)\n\nChoose option:\n```\n\n---\n\n## Orchestrator Intelligence Features\n\n### 1. Confidence Scoring Per Field\n\nThe AI doesn't just give overall confidence - it scores each field:\n\n```json\n{\n  \"field_confidence\": {\n    \"document_type\": 0.95,    // Very confident\n    \"document_date\": 0.40,    // NOT confident - will ask\n    \"title\": 0.85,            // Confident\n    \"relevancy_score\": 0.70,  // Borderline - might ask\n    \"case_numbers\": 0.60      // Uncertain - will ask\n  }\n}\n```\n\n**Threshold:** Ask question if confidence < 0.70\n\n### 2. Ambiguity Detection\n\nBot identifies specific ambiguities:\n\n```json\n{\n  \"ambiguities\": [\n    \"Name 'J. Smith' could be 'John Smith' or 'Jane Smith'\",\n    \"Two dates found: document date unclear\",\n    \"Handwritten text in section 3 is illegible\",\n    \"Stamp partially covers case number\"\n  ]\n}\n```\n\nThese appear in preview as notes.\n\n### 3. Smart Question Generation\n\nAI generates context-aware questions:\n\n```json\n{\n  \"question\": \"I see two dates (08/04/2024 and 08/15/2024). Which is the document date?\",\n  \"field\": \"document_date\",\n  \"options\": [\"20240804\", \"20240815\", \"Unknown\"],\n  \"reason\": \"Multiple dates found in document\",\n  \"current_guess\": \"20240804\"\n}\n```\n\n### 4. Metadata Extraction Verification\n\nFor critical fields like case numbers and names:\n\n```json\n{\n  \"metadata\": {\n    \"case_numbers\": [\"24-7889\"],        // Found\n    \"names\": [\"J. Smith\", \"Rodriguez\"], // Might need clarification\n    \"locations\": [\"Richmond\"],           // Clear\n    \"confidence_notes\": \"Name 'J. Smith' is abbreviated - full name unclear\"\n  }\n}\n```\n\n---\n\n## Comparison: 3 Bot Modes\n\n### Mode 1: Original Bot ([telegram_document_bot.py](telegram_document_bot.py))\n- **User does everything** - 7-step manual form\n- **No AI** - You provide all metadata\n- **No preview** - Commits immediately\n- **Use when:** You want full manual control\n\n### Mode 2: Enhanced Bot ([telegram_document_bot_enhanced.py](telegram_document_bot_enhanced.py))\n- **AI does everything** - Analyzes and commits automatically\n- **Fast** - ~20 seconds total\n- **Risk:** Might guess wrong on ambiguous fields\n- **Use when:** Document is clear, high confidence acceptable\n\n### Mode 3: Orchestrator Bot ([telegram_bot_orchestrator.py](telegram_bot_orchestrator.py)) â­\n- **AI + Human partnership** - AI asks when uncertain\n- **Accurate** - Questions improve confidence to 90%+\n- **Safe** - Preview before commit, editable fields\n- **Use when:** You want accuracy AND speed\n\n---\n\n## Configuration\n\n### Confidence Threshold\n\nEdit [telegram_bot_orchestrator.py:134](telegram_bot_orchestrator.py:134):\n\n```python\nself.uncertainty_threshold = 0.7  # Default: Ask if confidence < 70%\n```\n\n**Lower threshold (0.5):** Ask fewer questions, accept more risk\n**Higher threshold (0.9):** Ask more questions, maximize accuracy\n\n### Field-Specific Thresholds\n\nYou can set different thresholds per field:\n\n```python\nfield_thresholds = {\n    'document_date': 0.8,      # High threshold - dates are critical\n    'document_type': 0.7,      # Medium threshold\n    'title': 0.6,              # Lower threshold - less critical\n    'relevancy_score': 0.5     # Lowest - subjective anyway\n}\n```\n\n---\n\n## Usage Instructions\n\n### Start Orchestrator Bot\n\n```bash\ncd ASEAGI\n\n# Kill any existing bot\npython -c \"import psutil; [p.kill() for p in psutil.process_iter() if 'telegram' in ' '.join(p.cmdline() or []).lower()]\"\n\n# Start orchestrator\npython telegram_bot_orchestrator.py\n```\n\n**Output:**\n```\n======================================================================\nðŸ¤– ASEAGI Telegram Bot - Orchestrator (Human-in-the-Loop)\n======================================================================\nâœ… Tier 1 OCR: Enabled\nâœ… Tier 2 AI: Enabled\nâœ… Storage: Enabled\nâœ… Orchestration: Enabled\n======================================================================\n\nâœ… Orchestrator bot is running! Press Ctrl+C to stop.\n\nFeatures:\n  â€¢ AI asks clarifying questions when uncertain\n  â€¢ Preview before commit\n  â€¢ Edit any field before upload\n  â€¢ Human-friendly error explanations\n```\n\n### On Your Phone\n\n1. Open Telegram â†’ **@ASIAGI_bot**\n2. Send `/start`\n3. Send document image (with optional caption)\n4. Answer any questions the AI asks\n5. Review preview\n6. Edit fields if needed\n7. Confirm upload\n\n---\n\n## Advanced: Custom Question Logic\n\nYou can customize what questions get asked by editing the prompt in [telegram_bot_orchestrator.py:156](telegram_bot_orchestrator.py:156):\n\n### Example: Always Ask About Sexual Assault Cases\n\n```python\nprompt += \"\"\"\n\nSPECIAL RULES:\n1. If document mentions \"sexual assault\", \"rape\", or \"abuse\":\n   - ALWAYS set relevancy to Critical (920)\n   - ALWAYS ask for verification: \"This appears to be a sexual assault case. Confirm relevancy: Critical (920)?\"\n\n2. If multiple victims are mentioned:\n   - Ask: \"I see multiple names. Who is the primary victim?\"\n\n3. If handwritten notes are present:\n   - Ask: \"There are handwritten notes. Can you transcribe key points?\"\n\"\"\"\n```\n\n---\n\n## Benefits\n\n### For Accuracy\n- **90%+ confidence** on final uploads (vs 70-80% with auto mode)\n- **Fewer errors** from ambiguous documents\n- **Human verification** on critical fields\n\n### For Speed\n- **Faster than manual** - Only asks what's needed (not all 7 fields)\n- **Slower than auto** - But worth it for accuracy\n- **Average: 30-60 seconds** per document (vs 20s auto, 3min manual)\n\n### For Trust\n- **Explainable AI** - Shows confidence scores\n- **Transparent** - Preview before commit\n- **Controllable** - Edit any field\n- **Error recovery** - Retry with guidance\n\n---\n\n## Cost\n\n**Same as Enhanced Bot:**\n- Claude API: ~$0.01-0.02 per document\n- Supabase: Free tier\n- **Total: $1-2/month for <100 uploads**\n\nOrchestration uses ~25% more tokens (asks questions), but still very cheap.\n\n---\n\n## Troubleshooting\n\n### \"Bot not asking questions\"\n\n**Cause:** All fields have high confidence\n\n**Solution:** This is good! Bot is confident. Preview will still show before commit.\n\n### \"Too many questions\"\n\n**Cause:** Document is ambiguous or low quality\n\n**Solutions:**\n1. Use higher quality scans\n2. Add more context in caption\n3. Lower uncertainty threshold in config\n\n### \"Questions are repetitive\"\n\n**Cause:** AI prompt may need tuning\n\n**Solution:** Edit prompt at [telegram_bot_orchestrator.py:156](telegram_bot_orchestrator.py:156) to be more specific\n\n---\n\n## Next Steps\n\n1. **Test with clear document** - See how it handles high-confidence case\n2. **Test with ambiguous document** - See question asking in action\n3. **Adjust threshold** - Fine-tune when questions are asked\n4. **Customize prompts** - Add domain-specific logic\n\n**This is the recommended bot for production use!** ðŸš€\n\nIt combines the speed of AI with the accuracy of human oversight.\n",
  "content_preview": "# Human-in-the-Loop Orchestration Guide\n\n## Overview\n\nThe orchestration bot is an **intelligent agent** that knows when to ask for human help instead of guessing. It provides:\n\n1. **Uncertainty Detection** - AI identifies what it's NOT confident about\n2. **Clarifying Questions** - Asks you via chat when uncertain\n3. **Preview Before Commit** - Shows exactly what will be saved\n4. **Field Editing** - Let you fix any mistakes before upload\n5. **Error Explanations** - Human-friendly error messages w...",
  "sections": [
    {
      "title": "Human-in-the-Loop Orchestration Guide",
      "content": ""
    },
    {
      "title": "Overview",
      "content": "The orchestration bot is an **intelligent agent** that knows when to ask for human help instead of guessing. It provides:\n1. **Uncertainty Detection** - AI identifies what it's NOT confident about\n2. **Clarifying Questions** - Asks you via chat when uncertain\n3. **Preview Before Commit** - Shows exactly what will be saved\n4. **Field Editing** - Let you fix any mistakes before upload\n5. **Error Explanations** - Human-friendly error messages with solutions\n---"
    },
    {
      "title": "How It Works",
      "content": ""
    },
    {
      "title": "Traditional AI Bot (Auto-Pilot)",
      "content": "```\nImage â†’ AI Analysis â†’ Save to Database\n         â†“\n    (Might guess wrong!)\n```"
    },
    {
      "title": "Orchestration Bot (Human-in-the-Loop)",
      "content": "```\nImage â†’ AI Analysis â†’ Uncertainty Detection\n                           â†“\n                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”\n                   â†“              â†“\n            Confident?         Uncertain?\n                   â†“              â†“\n            Skip to Preview   Ask Questions\n                   â†“              â†“\n                Preview â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                   â†“\n            Edit Fields? (Optional)\n                   â†“\n            Final Confirmation\n                   â†“\n            Save to Database\n```\n---"
    },
    {
      "title": "Example Conversation Flow",
      "content": ""
    },
    {
      "title": "Scenario: Police Report with Ambiguous Date",
      "content": "**You:**\n> [Send police report image with caption]\n> \"Richmond PD sexual assault report\"\n**Bot:**\n> ðŸ” Analyzing document with AI...\n>\n> âœ… Initial Analysis Complete\n>\n> ðŸŽ¯ My Confidence: 65%\n>\n> ðŸ“ Document Type: ðŸš” Police Report\n> ðŸ“… Date: 20240804\n> ðŸ“Œ Title: Sexual Assault Report - Richmond PD\n> â­ Relevancy: 920\n>\n> ðŸ¤” **I have some questions to improve accuracy:**\n>\n> **Question 1 of 2:**\n>\n> I found two dates in the document (08/04/2024 and 08/15/2024). Which is the official document date?\n>\n> *Reason: Multiple dates found*\n**[Keyboard appears with options]:**\n- 20240804\n- 20240815\n- Unknown\n**You:**\n> 20240804\n**Bot:**\n> **Question 2 of 2:**\n>\n> I see a name that looks like \"J. Smith\". Is this:\n> - John Smith\n> - Jane Smith\n> - Unknown\n>\n> *Reason: Ambiguous name abbreviation*\n**You:**\n> Jane Smith\n**Bot:**\n> ðŸ“‹ **PREVIEW - What Will Be Saved**\n>\n> ðŸŽ¯ Overall Confidence: 92% (improved with your help!)\n>\n> ðŸ“ Document Type: ðŸš” Police Report\n> ðŸ“… Date: 20240804\n> ðŸ“Œ Title: Sexual Assault Report - Richmond PD\n> â­ Relevancy Score: 920\n>\n> ðŸ“„ Summary:\n> Police report documenting sexual assault allegation filed by Jane Smith on August 4, 2024...\n>\n> ðŸ“‹ Case Numbers: 24-7889\n> ðŸ‘¤ Names Mentioned: Jane Smith, Officer Rodriguez\n> ðŸ“ Locations: Richmond\n>\n> ðŸ“ OCR Text Preview:"
    },
    {
      "title": "> RICHMOND POLICE DEPARTMENT",
      "content": ""
    },
    {
      "title": "> REPORT #24-7889",
      "content": ""
    },
    {
      "title": "> DATE: 08/04/2024...",
      "content": ">\n> **What would you like to do?**\n**[Keyboard options]:**\n- âœ… Looks good - Upload now\n- âœï¸ Edit a field\n- âŒ Cancel\n**You:**\n> âœ… Looks good - Upload now\n**Bot:**\n> â³ Uploading to database and storage...\n>\n> âœ… **Upload Successful!**\n>\n> ðŸ†” Database ID: 1234\n> ðŸ“„ Filename: 20240804_PLCR_Sexual_Assault_Report_REL-920_20250105_143022.jpg\n> ðŸŽ¯ AI Confidence: 92%\n>\n> ðŸ”— URL: https://jvjlhxodmbkodzmggwpu.supabase.co/storage/...\n>\n> âœ¨ Your document is now saved!\n>\n> Use /start to upload another.\n---"
    },
    {
      "title": "When Bot Asks Questions",
      "content": ""
    },
    {
      "title": "High Confidence (90%+) - No Questions",
      "content": "```\nClear document, no ambiguity\n        â†“\nGoes straight to preview\n```"
    },
    {
      "title": "Medium Confidence (70-89%) - 1-2 Questions",
      "content": "```\nSome uncertain fields\n        â†“\nAsk specific clarifying questions\n```"
    },
    {
      "title": "Low Confidence (<70%) - Multiple Questions",
      "content": "```\nLots of uncertainty\n        â†“\nAsk several questions to improve accuracy\n```\n---"
    },
    {
      "title": "Types of Questions Asked",
      "content": ""
    },
    {
      "title": "1. Date Ambiguity",
      "content": "**Example:**\n```\nQuestion: I found two dates (08/04/2024 and 08/15/2024).\n          Which is the document date?\nOptions:\n  â€¢ 20240804\n  â€¢ 20240815\n  â€¢ Unknown\nReason: Multiple dates found\n```"
    },
    {
      "title": "2. Document Type Uncertainty",
      "content": "**Example:**\n```\nQuestion: Is this a Police Report or a CPS Report?\nOptions:\n  â€¢ ðŸš” Police Report\n  â€¢ ðŸ‘¶ CPS Report\nReason: Header mentions both agencies\n```"
    },
    {
      "title": "3. Name Disambiguation",
      "content": "**Example:**\n```\nQuestion: The name \"J. Smith\" appears. Who is this?\nYour answer: [Type name or \"Unknown\"]\nReason: Ambiguous name abbreviation\n```"
    },
    {
      "title": "4. Case Number Extraction",
      "content": "**Example:**\n```\nQuestion: I see \"#24-7889\" and \"Case 2024-07889\".\n          Which is the correct case number?\nOptions:\n  â€¢ 24-7889\n  â€¢ 2024-07889\n  â€¢ Both (separate cases)\nReason: Multiple case number formats found\n```"
    },
    {
      "title": "5. Relevancy Assessment",
      "content": "**Example:**\n```\nQuestion: This document contains allegations of abuse.\n          Should relevancy be Critical (920) or High (850)?\nOptions:\n  â€¢ Critical (920) - Sexual assault allegations\n  â€¢ High (850) - General abuse allegation\nReason: Need context for severity scoring\n```\n---"
    },
    {
      "title": "Field Editing",
      "content": "If you see something wrong in the preview, you can edit it:\n**Bot shows preview:**\n```\nðŸ“ Document Type: ðŸš” Police Report\nðŸ“… Date: 20240804\nðŸ“Œ Title: Sexual Assault Report - Richmond PD\n```\n**You click:** âœï¸ Edit a field\n**Bot:**\n```\nWhich field would you like to edit?\n  â€¢ Document Type\n  â€¢ Document Date\n  â€¢ Title\n  â€¢ Summary/Notes\n  â€¢ Relevancy Score\n  â€¢ âŒ Cancel edit - Go back to preview\n```\n**You select:** Title\n**Bot:**\n```\nEnter new title:\n```\n**You type:**\n```\nInitial Sexual Assault Report - Richmond PD Case 24-7889\n```\n**Bot:**\n```\nâœ… Title updated!\n[Shows updated preview]\n```\n---"
    },
    {
      "title": "Error Handling with Explanations",
      "content": ""
    },
    {
      "title": "Scenario: Duplicate Document",
      "content": "**Bot:**\n```\nðŸ”„ **Duplicate Detected**\nThis document appears to be identical to one already uploaded.\nExisting: 20240804_PLCR_Sexual_Assault_Report_REL-920.jpg\nUploaded: 2024-08-05\nSimilarity: 100% (identical MD5 hash)\nOptions:\n1. Skip upload (keep existing)\n2. Upload anyway (mark as version)\n3. Replace existing document\nWhat would you like to do?\n```"
    },
    {
      "title": "Scenario: Storage Bucket Missing",
      "content": "**Bot:**\n```\nâ˜ï¸ **Storage Upload Failed**\nCould not save image to cloud storage.\nPossible causes:\nâ€¢ Storage bucket 'documents' not created\nâ€¢ Network connection issue\nâ€¢ File size too large\nThe metadata was saved, but image upload failed.\nQuick fix:\n1. Go to Supabase Dashboard\n2. Storage â†’ Create bucket named 'documents'\n3. Set Public: YES\n4. Try uploading again\nWould you like to retry?\n```"
    },
    {
      "title": "Scenario: Database Schema Error",
      "content": "**Bot:**\n```\nðŸ’¾ **Database Schema Issue**\nThe database doesn't have the expected field structure.\nTechnical details: Could not find the 'full_text_content' column\nThis might need database migration or schema update.\nYou can:\n1. Contact database admin\n2. Check schema in Supabase Dashboard\n3. Upload with basic metadata only (skip OCR text)\nChoose option:\n```\n---"
    },
    {
      "title": "Orchestrator Intelligence Features",
      "content": ""
    },
    {
      "title": "1. Confidence Scoring Per Field",
      "content": "The AI doesn't just give overall confidence - it scores each field:\n```json\n{\n  \"field_confidence\": {\n    \"document_type\": 0.95,    // Very confident\n    \"document_date\": 0.40,    // NOT confident - will ask\n    \"title\": 0.85,            // Confident\n    \"relevancy_score\": 0.70,  // Borderline - might ask\n    \"case_numbers\": 0.60      // Uncertain - will ask\n  }\n}\n```\n**Threshold:** Ask question if confidence < 0.70"
    },
    {
      "title": "2. Ambiguity Detection",
      "content": "Bot identifies specific ambiguities:\n```json\n{\n  \"ambiguities\": [\n    \"Name 'J. Smith' could be 'John Smith' or 'Jane Smith'\",\n    \"Two dates found: document date unclear\",\n    \"Handwritten text in section 3 is illegible\",\n    \"Stamp partially covers case number\"\n  ]\n}\n```\nThese appear in preview as notes."
    },
    {
      "title": "3. Smart Question Generation",
      "content": "AI generates context-aware questions:\n```json\n{\n  \"question\": \"I see two dates (08/04/2024 and 08/15/2024). Which is the document date?\",\n  \"field\": \"document_date\",\n  \"options\": [\"20240804\", \"20240815\", \"Unknown\"],\n  \"reason\": \"Multiple dates found in document\",\n  \"current_guess\": \"20240804\"\n}\n```"
    },
    {
      "title": "4. Metadata Extraction Verification",
      "content": "For critical fields like case numbers and names:\n```json\n{\n  \"metadata\": {\n    \"case_numbers\": [\"24-7889\"],        // Found\n    \"names\": [\"J. Smith\", \"Rodriguez\"], // Might need clarification\n    \"locations\": [\"Richmond\"],           // Clear\n    \"confidence_notes\": \"Name 'J. Smith' is abbreviated - full name unclear\"\n  }\n}\n```\n---"
    },
    {
      "title": "Comparison: 3 Bot Modes",
      "content": ""
    },
    {
      "title": "Mode 1: Original Bot ([telegram_document_bot.py](telegram_document_bot.py))",
      "content": "- **User does everything** - 7-step manual form\n- **No AI** - You provide all metadata\n- **No preview** - Commits immediately\n- **Use when:** You want full manual control"
    },
    {
      "title": "Mode 2: Enhanced Bot ([telegram_document_bot_enhanced.py](telegram_document_bot_enhanced.py))",
      "content": "- **AI does everything** - Analyzes and commits automatically\n- **Fast** - ~20 seconds total\n- **Risk:** Might guess wrong on ambiguous fields\n- **Use when:** Document is clear, high confidence acceptable"
    },
    {
      "title": "Mode 3: Orchestrator Bot ([telegram_bot_orchestrator.py](telegram_bot_orchestrator.py)) â­",
      "content": "- **AI + Human partnership** - AI asks when uncertain\n- **Accurate** - Questions improve confidence to 90%+\n- **Safe** - Preview before commit, editable fields\n- **Use when:** You want accuracy AND speed\n---"
    },
    {
      "title": "Configuration",
      "content": ""
    },
    {
      "title": "Confidence Threshold",
      "content": "Edit [telegram_bot_orchestrator.py:134](telegram_bot_orchestrator.py:134):\n```python\nself.uncertainty_threshold = 0.7  # Default: Ask if confidence < 70%\n```\n**Lower threshold (0.5):** Ask fewer questions, accept more risk\n**Higher threshold (0.9):** Ask more questions, maximize accuracy"
    },
    {
      "title": "Field-Specific Thresholds",
      "content": "You can set different thresholds per field:\n```python\nfield_thresholds = {\n    'document_date': 0.8,      # High threshold - dates are critical\n    'document_type': 0.7,      # Medium threshold\n    'title': 0.6,              # Lower threshold - less critical\n    'relevancy_score': 0.5     # Lowest - subjective anyway\n}\n```\n---"
    },
    {
      "title": "Usage Instructions",
      "content": ""
    },
    {
      "title": "Start Orchestrator Bot",
      "content": "```bash\ncd ASEAGI"
    },
    {
      "title": "Kill any existing bot",
      "content": "python -c \"import psutil; [p.kill() for p in psutil.process_iter() if 'telegram' in ' '.join(p.cmdline() or []).lower()]\""
    },
    {
      "title": "Start orchestrator",
      "content": "python telegram_bot_orchestrator.py\n```\n**Output:**\n```\n======================================================================\nðŸ¤– ASEAGI Telegram Bot - Orchestrator (Human-in-the-Loop)\n======================================================================\nâœ… Tier 1 OCR: Enabled\nâœ… Tier 2 AI: Enabled\nâœ… Storage: Enabled\nâœ… Orchestration: Enabled\n======================================================================\nâœ… Orchestrator bot is running! Press Ctrl+C to stop.\nFeatures:\n  â€¢ AI asks clarifying questions when uncertain\n  â€¢ Preview before commit\n  â€¢ Edit any field before upload\n  â€¢ Human-friendly error explanations\n```"
    },
    {
      "title": "On Your Phone",
      "content": "1. Open Telegram â†’ **@ASIAGI_bot**\n2. Send `/start`\n3. Send document image (with optional caption)\n4. Answer any questions the AI asks\n5. Review preview\n6. Edit fields if needed\n7. Confirm upload\n---"
    },
    {
      "title": "Advanced: Custom Question Logic",
      "content": "You can customize what questions get asked by editing the prompt in [telegram_bot_orchestrator.py:156](telegram_bot_orchestrator.py:156):"
    },
    {
      "title": "Example: Always Ask About Sexual Assault Cases",
      "content": "```python\nprompt += \"\"\""
    },
    {
      "title": "SPECIAL RULES:",
      "content": "1. If document mentions \"sexual assault\", \"rape\", or \"abuse\":\n   - ALWAYS set relevancy to Critical (920)\n   - ALWAYS ask for verification: \"This appears to be a sexual assault case. Confirm relevancy: Critical (920)?\"\n2. If multiple victims are mentioned:\n   - Ask: \"I see multiple names. Who is the primary victim?\"\n3. If handwritten notes are present:\n   - Ask: \"There are handwritten notes. Can you transcribe key points?\"\n\"\"\"\n```\n---"
    },
    {
      "title": "Benefits",
      "content": ""
    },
    {
      "title": "For Accuracy",
      "content": "- **90%+ confidence** on final uploads (vs 70-80% with auto mode)\n- **Fewer errors** from ambiguous documents\n- **Human verification** on critical fields"
    },
    {
      "title": "For Speed",
      "content": "- **Faster than manual** - Only asks what's needed (not all 7 fields)\n- **Slower than auto** - But worth it for accuracy\n- **Average: 30-60 seconds** per document (vs 20s auto, 3min manual)"
    },
    {
      "title": "For Trust",
      "content": "- **Explainable AI** - Shows confidence scores\n- **Transparent** - Preview before commit\n- **Controllable** - Edit any field\n- **Error recovery** - Retry with guidance\n---"
    },
    {
      "title": "Cost",
      "content": "**Same as Enhanced Bot:**\n- Claude API: ~$0.01-0.02 per document\n- Supabase: Free tier\n- **Total: $1-2/month for <100 uploads**\nOrchestration uses ~25% more tokens (asks questions), but still very cheap.\n---"
    },
    {
      "title": "Troubleshooting",
      "content": ""
    },
    {
      "title": "\"Bot not asking questions\"",
      "content": "**Cause:** All fields have high confidence\n**Solution:** This is good! Bot is confident. Preview will still show before commit."
    },
    {
      "title": "\"Too many questions\"",
      "content": "**Cause:** Document is ambiguous or low quality\n**Solutions:**\n1. Use higher quality scans\n2. Add more context in caption\n3. Lower uncertainty threshold in config"
    },
    {
      "title": "\"Questions are repetitive\"",
      "content": "**Cause:** AI prompt may need tuning\n**Solution:** Edit prompt at [telegram_bot_orchestrator.py:156](telegram_bot_orchestrator.py:156) to be more specific\n---"
    },
    {
      "title": "Next Steps",
      "content": "1. **Test with clear document** - See how it handles high-confidence case\n2. **Test with ambiguous document** - See question asking in action\n3. **Adjust threshold** - Fine-tune when questions are asked\n4. **Customize prompts** - Add domain-specific logic\n**This is the recommended bot for production use!** ðŸš€\nIt combines the speed of AI with the accuracy of human oversight."
    }
  ],
  "extraction_success": true,
  "extraction_error": null
}